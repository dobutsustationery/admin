---
name: Copilot Setup Steps

# This workflow demonstrates the environment setup steps and can be triggered manually.
# It does NOT run on pull requests to avoid unnecessary resource usage.
# For actual E2E testing on PRs, see e2e-tests.yml

on:
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read

jobs:
  copilot-setup-steps:
    name: Setup Development Environment
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Cache Firebase Emulators
        uses: actions/cache@v4
        with:
          path: ~/.cache/firebase/emulators
          key: ${{ runner.os }}-firebase-emulators-${{ hashFiles('firebase.json') }}
          restore-keys: |
            ${{ runner.os }}-firebase-emulators-

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Start Firebase Emulators
        run: |
          # Start emulators in background
          npx firebase-tools emulators:start --project demo-test-project &
          EMULATOR_PID=$!
          echo "EMULATOR_PID=$EMULATOR_PID" >> $GITHUB_ENV

          # Wait for emulators to be ready
          echo "Waiting for Firestore emulator..."
          for i in {1..60}; do
            if curl -s http://localhost:8080 > /dev/null 2>&1; then
              echo "✓ Firestore emulator is ready"
              break
            fi
            if [ $i -eq 60 ]; then
              echo "❌ Emulators failed to start after 60 seconds"
              exit 1
            fi
            sleep 1
          done

          echo "Waiting for Auth emulator..."
          for i in {1..30}; do
            if curl -s http://localhost:9099 > /dev/null 2>&1; then
              echo "✓ Auth emulator is ready"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "⚠️  Auth emulator not ready, but continuing"
              break
            fi
            sleep 1
          done

      - name: Load test data into emulator
        run: node e2e/helpers/load-test-data.js --match-jancodes=10

      - name: Display environment info
        run: |
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          echo "Working directory: $(pwd)"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref }}"

      - name: Setup complete
        run: echo "✓ Environment setup completed successfully"
